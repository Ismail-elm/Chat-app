<!DOCTYPE html>
{% load static %}
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Chat app</title>
    <link rel="stylesheet" href="{% static 'chatapp/styles3.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
</head>
<body class="messagerie-page">
    <!-- En-tÃªte -->
    <div id="entete">
        <div id="logout">
            <a href="{% url 'logout' %}">Logout</a>
        </div>
        <div id="profile">
            <i class="fa-solid fa-user"></i>
            <p>{{ username }}</p>
        </div>
    </div>

    <!-- Section principale -->
    <div id="main-section">
        <div id="left-section">
            <!-- Liste des salons -->
            <div class="discussions salons-list">
                <h3 class="section-title">Salons</h3>
                <form method="post" class="create-salon-form">
                    {% csrf_token %}
                    <input type="text" placeholder="Nouveau salon" name="salon_name" required class="text-input">
                    <input type="submit" value="âž•" name="create_salon" class="btn create-btn">
                </form>
                {% for salon in salons %}
                    <a href="{% url 'messagerie' name=username salon_id=salon.id %}" class="salon-item">
                        <p>{{ salon.salon_name }}</p>
                        <p>{{ salon.created_at|date:"d/m/Y H:i" }}</p>
                    </a>
                {% endfor %}
            </div>
            <!-- Liste des membres -->
            <div class="discussions members-list" id="members-list">
                <h3 class="section-title">Members</h3>
                <!-- Quitter ou supprimer un salon -->
                <form method="post" class="leave-delete-form">
                    {% csrf_token %}
                    {% if myuser == creator %}
                        <input type="submit" value="âŒ Delete salon " name="delete_salon" class="btn delete-btn">
                    {% else %}
                        <input type="submit" value="â¬…ï¸ Leave salon" name="leave_salon" class="btn leave-btn">
                    {% endif %}
                </form>
                <!-- Ajouter un membre si tu es createur du salon -->
                {% if myuser == creator %} 
                    <form method="post" class="add-member-form">
                        {% csrf_token %}
                        <input type="text" placeholder="Nouveau membre" name="member_name" required class="text-input">
                        <input type="submit" value="âž•" name="add_member" class="btn add-btn">
                        <p class="error-message">{% if user_not_found %}Utilisateur non trouvÃ©{% endif %}</p>
                    </form>
                {% endif %}
                <!-- Afficher les membres -->
                {% for member in members %}
                    <div class="member-item">
                        <p>{% if member == creator %}ðŸ‘‘{% else %}ðŸ‘¤{% endif %} {{ member.username_text }} {% if member == myuser %} (Vous) {% endif %}</p>
                        {% if myuser == creator and member != creator %}
                            <form method="post" class="remove-member-form">
                                {% csrf_token %}
                                <input type="hidden" name="remove_member" value="{{ member.id }}">
                                <input type="submit" value="ðŸš«" name="Remove_member" class="btn remove-btn">
                            </form>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>
        </div>
        <!-- Zone des messages -->
        <div id="messages" class="messages-container">
            {% if messages %}
                {% for msg in messages %}
                    <div class="message {% if msg.user == myuser %}me{% else %}other{% endif %}">
                        {% if msg.user == myuser or myuser == creator %}
                        <form method="post" class="remove-message-form">
                            {% csrf_token %}
                            <input type="hidden" name="remove_message" value="{{ msg.id }}">
                            <button type="submit" name="Remove_message" class="message-delete-btn" title="Delete message">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </form>
                        {% endif %}
                        <div class="message-header">
                            <span class="username">{{ msg.user.username_text }}</span>
                        </div>
                        <p class="message-text">{{ msg.message_text }}</p>
                        <span class="time">{{ msg.written_at|date:"H:i" }}</span>
                    </div>
                {% endfor %}
            {% else %}
                <p class="no-messages">Aucun message pour le moment. Envoyez le premier !</p>
            {% endif %}
            <!-- Zone de saisie -->
            <form id="text-area" method="post" class="send-message-form">
                {% csrf_token %}
                <input type="text" placeholder="Ã‰crire un message" name="my_message" required class="text-input message-input" id="chat-input">
                <i class="fa-regular fa-face-grin-wink emoji-icon"></i>
                <input type="submit" value="Envoyer" name="send_message" id="send-btn" class="btn send-btn">
            </form>
        </div>
    </div>
    {% load static %}
    <script>
        const csrfToken = "{{ csrf_token }}";
        const username = "{{ username }}";
        const salonId = {{ salon.id }};
        const isCreator = {{ myuser == creator|lower }};
    </script>
    <script src="{% static 'chatapp/script.js' %}"></script>
</body>
</html>
